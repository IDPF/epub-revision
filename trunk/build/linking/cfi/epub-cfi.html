<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <title>Canonical Fragment Identifiers (CFI) for EPUB</title>
      <link rel="stylesheet" type="text/css" href="../epub-spec.css"/>
      <meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/>
      <meta name="description" content="This specification ..."/>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
   </head>
   <body>
      <div class="book" title="Canonical Fragment Identifiers (CFI) for EPUB">
         <h1 class="title">Canonical Fragment Identifiers (CFI) for EPUB</h1>
         <p class="identity">
            <span class="releaseinfo">Working Group Draft</span> 
            <span class="pubdate">29 April 2011</span>
         </p>
         <dl class="printhistory">
            <dt>This version</dt>
            <dd>
                    <a class="link" href="http://www.idpf.org/epub/linking/20110429/epub-linking.html">http://www.idpf.org/epub/linking/20110429/epub-linking.html</a>
                </dd>
            <dt>Latest version</dt>
            <dd>
                    <a class="link" href="http://www.idpf.org/epub/linking/epub-linking.html">http://www.idpf.org/epub/linking/epub-linking.html</a>
                </dd>
            <dt>Previous version</dt>
            <dd>N/A</dd>
            <dt>Diffs to previous version</dt>
            <dd>N/A</dd>
         </dl>
         <div class="legal">
            <p class="copyright">Copyright © 2010, 2011 International Digital Publishing Forum™</p>
            <div class="legalnotice" title="Legal Notice">
               <a id="d55e41"/>
               <p class="para">All rights reserved. This work is protected under Title 17 of the United States Code.
        Reproduction and dissemination of this work with changes is prohibited except with the
        written permission of the <a class="link" href="http://www.idpf.org">International Digital
        Publishing Forum (IDPF)</a>.</p>
               <p class="para">EPUB is a registered trademark of the International Digital Publishing Forum.</p>
            </div>
         </div>
         <div class="authorgroup">
            <p class="bridgehead">Editors (this version)</p>
            <p class="editor">Peter Sorotokin, 
                        Adobe
                    </p>
            <p class="editor">Garth Conboy, 
                        Google Inc.
                    </p>
         </div>
         <div class="toc">
            <p>
               <strong>Table of Contents</strong>
            </p>
            <dl>
               <dt>
                  <span class="chapter">
                     <a href="#sec-overview">1. Overview</a>
                  </span>
               </dt>
               <dd>
                  <dl>
                     <dt>
                        <span class="section">
                           <a href="#sec-overview-purpose-and-scope">1.1. Purpose and Scope</a>
                        </span>
                     </dt>
                     <dt>
                        <span class="section">
                           <a href="#sec-overview-relations">1.2. Relationship to Other Specifications</a>
                        </span>
                     </dt>
                     <dt>
                        <span class="section">
                           <a href="#sec-overview-versioning">1.3. Versioning Strategy</a>
                        </span>
                     </dt>
                     <dt>
                        <span class="section">
                           <a href="#sec-terminology">1.4. Terminology</a>
                        </span>
                     </dt>
                     <dt>
                        <span class="section">
                           <a href="#sec-conformance">1.5. Conformance Statements</a>
                        </span>
                     </dt>
                  </dl>
               </dd>
               <dt>
                  <span class="chapter">
                     <a href="#d55e138">2. Overview</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#d55e158">3. EPUB Canonical Fragment Identifier (epubcfi) Specification</a>
                  </span>
               </dt>
               <dd>
                  <dl>
                     <dt>
                        <span class="section">
                           <a href="#d55e176">3.1. epubcfi Syntax</a>
                        </span>
                     </dt>
                     <dd>
                        <dl>
                           <dt>
                              <span class="section">
                                 <a href="#d55e187">3.1.1. Path Resolution</a>
                              </span>
                           </dt>
                           <dd>
                              <dl>
                                 <dt>
                                    <span class="section">
                                       <a href="#d55e194">3.1.1.1. "/" Step Reference to Child Node</a>
                                    </span>
                                 </dt>
                                 <dt>
                                    <span class="section">
                                       <a href="#d55e234">3.1.1.2. "[" XML ID Assertion</a>
                                    </span>
                                 </dt>
                                 <dt>
                                    <span class="section">
                                       <a href="#d55e241">3.1.1.3. "!" Step Indirection</a>
                                    </span>
                                 </dt>
                                 <dt>
                                    <span class="section">
                                       <a href="#d55e286">3.1.1.4. ":" Terminating Step – Character Offset</a>
                                    </span>
                                 </dt>
                                 <dt>
                                    <span class="section">
                                       <a href="#d55e295">3.1.1.5. "~" Terminating Step – Temporal Offset</a>
                                    </span>
                                 </dt>
                                 <dt>
                                    <span class="section">
                                       <a href="#d55e302">3.1.1.6. "@" Terminating Step – Spacial Offset</a>
                                    </span>
                                 </dt>
                                 <dt>
                                    <span class="section">
                                       <a href="#d55e309">3.1.1.7. "~" + "@" Terminating Step – Temporal-Spacial Offset</a>
                                    </span>
                                 </dt>
                                 <dt>
                                    <span class="section">
                                       <a href="#d55e316">3.1.1.8. "[" Text Location Assertion</a>
                                    </span>
                                 </dt>
                                 <dt>
                                    <span class="section">
                                       <a href="#d55e341">3.1.1.9. "[" + ";s=" Side Bias</a>
                                    </span>
                                 </dt>
                              </dl>
                           </dd>
                           <dt>
                              <span class="section">
                                 <a href="#d55e385">3.1.2. Example</a>
                              </span>
                           </dt>
                           <dt>
                              <span class="section">
                                 <a href="#d55e428">3.1.3. Sorting Rules</a>
                              </span>
                           </dt>
                           <dt>
                              <span class="section">
                                 <a href="#d55e461">3.1.4. Relative CFI’s</a>
                              </span>
                           </dt>
                           <dt>
                              <span class="section">
                                 <a href="#d55e469">3.1.5. Simple Ranges</a>
                              </span>
                           </dt>
                           <dt>
                              <span class="section">
                                 <a href="#d55e497">3.1.6. Intended Target Location Correction</a>
                              </span>
                           </dt>
                           <dt>
                              <span class="section">
                                 <a href="#d55e521">3.1.7. Rules for Extensions</a>
                              </span>
                           </dt>
                        </dl>
                     </dd>
                  </dl>
               </dd>
               <dt>
                  <span class="bibliography">
                     <a href="#references">References</a>
                  </span>
               </dt>
            </dl>
         </div>
         <div class="chapter" title="1 Overview" id="sec-overview">
            <h2 class="title">
               <span class="link-marker">
                  <a class="hidden-reveal" title="Link here" href="#sec-overview">›</a> </span>1 Overview</h2>
            <div class="section" title="1.1 Purpose and Scope"
                 id="sec-overview-purpose-and-scope">
               <h3 class="title">
                  <span class="link-marker">
                     <a class="hidden-reveal" title="Link here" href="#sec-overview-purpose-and-scope">›</a> </span>1.1 Purpose and Scope</h3>
               <p class="para">The Web has proven that the concept of hyperlinking is tremendously powerful.
                EPUBs have been denied much of this benefit because there has been no standardized
                method of referencing content within an EPUB document. This specification provides a
                remedy for that situation. </p>
               <p class="para">Following are the considerations that have influenced the design:</p>
               <div class="itemizedlist">
                  <ul class="itemizedlist">
                     <li class="listitem">
                        <p class="para">Reading Systems should be interoperable, allowing one Reading System to
                        use a reading position created by another.</p>
                     </li>
                     <li class="listitem">
                        <p class="para">Document references to EPUB content should be enabled in the same way that
                        existing hyperlinks enable references throughout the Web.</p>
                     </li>
                     <li class="listitem">
                        <p class="para">Each location in an EPUB file should be able to be identified - without a
                        need to specifically modify the document</p>
                     </li>
                     <li class="listitem">
                        <p class="para">All fragment identifiers that reference the same logical location should
                        be equal when compared</p>
                     </li>
                     <li class="listitem">
                        <p class="para">Comparison operations, including tests for sorting and comparison, should
                        be able to be performed without accessing the referenced files</p>
                     </li>
                     <li class="listitem">
                        <p class="para">Simple manipulations should be possible without access to the original
                        files (e.g. given a reference deep in a file, it should be possible to
                        generate a reference to the start of the file)</p>
                     </li>
                     <li class="listitem">
                        <p class="para">Identifier resolution should be reasonably efficient (e.g. processing of
                        the first chapter is not required to resolve a fragment identifier that
                        points to the last chapter)</p>
                     </li>
                     <li class="listitem">
                        <p class="para">References should be bale to recover their target locations through parser
                        variations (e.g. whitespace jitter) and document revisions (edit
                        jitter)</p>
                     </li>
                     <li class="listitem">
                        <p class="para">An extensible mechanism to accommodate future reference recovery
                        heuristics should be provided</p>
                     </li>
                     <li class="listitem">
                        <p class="para">Expression of simple, contiguous ranges should be supported</p>
                     </li>
                  </ul>
               </div>
            </div>
            <div class="section" title="1.2 Relationship to Other Specifications"
                 id="sec-overview-relations">
               <h3 class="title">
                  <span class="link-marker">
                     <a class="hidden-reveal" title="Link here" href="#sec-overview-relations">›</a> </span>1.2 Relationship to Other Specifications</h3>
               <p class="informative"> This section is informative</p>
               <span class="todo">TODO</span>
            </div>
            <div class="section" title="1.3 Versioning Strategy" id="sec-overview-versioning">
               <h3 class="title">
                  <span class="link-marker">
                     <a class="hidden-reveal" title="Link here" href="#sec-overview-versioning">›</a> </span>1.3 Versioning Strategy</h3>
               <span class="todo">TODO</span>
            </div>
            <div class="section" title="1.4 Terminology" id="sec-terminology">
               <h3 class="title">
                  <span class="link-marker">
                     <a class="hidden-reveal" title="Link here" href="#sec-terminology">›</a> </span>1.4 Terminology</h3>
               <span class="todo">TODO</span>
            </div>
            <div class="section" title="1.5 Conformance Statements" id="sec-conformance">
               <h3 class="title">
                  <span class="link-marker">
                     <a class="hidden-reveal" title="Link here" href="#sec-conformance">›</a> </span>1.5 Conformance Statements</h3>
               <p class="para">The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
        "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as
        described in <a class="biblioref" href="#refRFC2119"
                     title="Key words for use in RFCs to Indicate Requirement Levels (RFC 2119)">[<abbr class="abbrev">RFC2119</abbr>]</a>.</p>
               <p class="para">All sections of this specification are normative except where identified by 
        the informative status label "This section is informative". The application of informative 
        status to sections and appendices applies to all child content and subsections 
        they may contain.</p>
               <p class="para">All examples in this specification are informative.</p>
            </div>
         </div>
         <div class="chapter" title="2 Overview">
            <h2 class="title">
               <span class="link-marker">
                  <a class="hidden-reveal" title="Link here" href="#d55e138">›</a> </span>2 Overview</h2>
            <p class="para">The situations that motivate references to locations within EPUB publications are
            varied (e.g. reading location maintenance, annotation attachment, navigation). As such,
            there may be a need for multiple referencing strategies. Defined herein is the first
            such method – an arbitrary structural reference that can uniquely identify any location,
            or simple range of locations, within an EPUB publication. </p>
            <p class="para">A Fragment Identifier is a part of a URI that defines a location within a resource.
            Syntactically, it is the part of URI that starts with # and is appended at the end of
            the URI of the file itself. For HTML documents, ids and named anchors are used as
            fragment identifiers. For XML documents, the Shorthand XPointer notation is used to
            refer to a given ID.</p>
            <p class="para">An EPUB Canonical Fragment Identifier structurally expresses a location within an EPUB
            publication. It is defined by the "epubcfi" Fragment Identifier method.</p>
            <p class="para">Example:</p>
            <div class="informalexample">
               <pre class="synopsis">demo.epub#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/3:10)</pre>
            </div>
            <p class="para">Syntax:</p>
            <pre class="programlisting">
reference:   "#" method
method:      "epubcfi"
        </pre>
            <p class="para">The details of the this "epubcfi" EPUB referencing method are defined herein.</p>
         </div>
         <div class="chapter"
              title="3 EPUB Canonical Fragment Identifier (epubcfi) Specification">
            <h2 class="title">
               <span class="link-marker">
                  <a class="hidden-reveal" title="Link here" href="#d55e158">›</a> </span>3 EPUB Canonical Fragment Identifier (epubcfi) Specification</h2>
            <p class="para">This specification defines syntax and semantics for structurally identifying a
            location within an EPUB publication – the "epubcfi" reference method.</p>
            <p class="para">Example:</p>
            <div class="informalexample">
               <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/3:10)</pre>
            </div>
            <p class="para">A Canonical Fragment Identifier (CFI) consists of an initial sequence "epubcfi" that
            identifies this particular reference method, and a parenthesized path or range. A path
            is build up as a sequence of structural steps to reference a location. A range is a path
            followed by two local (or relative) paths that identify the start and end of the
            range.</p>
            <p class="para">Note that "epub" is prepended to the name of the scheme, so that a more generic
            CFI-like scheme could be potentially defined in the future for all XML+ZIP-based file
            formats.</p>
            <p class="para">Steps can either be navigational or terminating. Navigational steps may be repeated as
            necessary (to count elements, to process children, or to follow references). There may
            be only one terminating step, which, if present, must be the last step in the sequence. </p>
            <p class="para">Sub-strings in brackets are extensible assertions that improve the robustness of
            traversing paths and migrating them from one revision of the document to another. These
            assertions preserve additional information about traversed elements of the document,
            which makes it possible to recover intended location even after some modifications were
            made to the publication.</p>
            <div class="section" title="3.1 epubcfi Syntax">
               <h3 class="title">
                  <span class="link-marker">
                     <a class="hidden-reveal" title="Link here" href="#d55e176">›</a> </span>3.1 epubcfi Syntax</h3>
               <p class="para">Syntax:</p>
               <pre class="programlisting">
fragment:    "epubcfi(" (path | range) ")" 

range:       path "," local_path "," local_path

path:        step local_path

local_path:  (step | "!")* termstep?

step:        "/" integer ("[" assertion "]")?


termstep:    terminus ("[" assertion "]")?

terminus:    ":" integer | "@" number ":" number |

            "~" number | "~" number "@" number ":" number 

number:      digit+ ("." digit+)?

integer:     digit+

assertion:   csv? parameters

parameters:  (";" param_name "=" csv)*

param_name:  xml_identifier

csv:         value ("," value)*

value:       string | quoted-string            // See below
            </pre>
               <p class="para">"value"s in the syntax above can either be a quoted string or a sequence of
                characters that do not interfere with parsing (specifically, any character except
                for quote ("), brackets ([,]), parenthesis ((,)), comma (,), and semicolon (;)).
                Quoted string is delimited by the quote (") character with quote and backslash (\)
                escaped using the backslash character.</p>
               <p class="para">To ensure uniqueness, leading zeros are not allowed for numbers or integers;
                trailing zeros are not allowed in the fractional part of a number; zero must be
                represented as the integer "0"; numbers in the range "1 &gt; N &gt; 0" must have a leading
                "0."; integral numbers must be represented as integers.</p>
               <div class="section" title="3.1.1 Path Resolution">
                  <h4 class="title">
                     <span class="link-marker">
                        <a class="hidden-reveal" title="Link here" href="#d55e187">›</a> </span>3.1.1 Path Resolution</h4>
                  <p class="para">The CFI is processed in the following manner. </p>
                  <p class="para">Assume that all documents are parsed into a W3C DOM tree (though, this is not
                    needed for actual implementation). Start with the root (document) XML element
                    node of the EPUB OPF file (i.e. package element - not DOM "document" node!).
                    Process each CFI step one by one, left to right, applying the following
                    rules.</p>
                  <div class="section" title="3.1.1.1 &#34;/&#34; Step Reference to Child Node">
                     <h5 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#d55e194">›</a> </span>3.1.1.1 "/" Step Reference to Child Node</h5>
                     <p class="para">A step with a "/" followed by an integer refers to a child node or nodes
                        in the following manner:</p>
                     <div class="orderedlist">
                        <ol class="orderedlist">
                           <li class="listitem">
                              <p class="para">Each element is assigned an <span class="emphasis">
                                    <em>even</em>
                                 </span> positive
                                index. The first element is given index 2, the second element index
                                4, etc.</p>
                           </li>
                           <li class="listitem">
                              <p class="para">Each (possibly empty) collection of non-element nodes before the
                                first element, between elements, and after the last element are
                                given <span class="emphasis">
                                    <em>odd</em>
                                 </span> indices according to their position.
                                Typically this refers to the text of the publication.</p>
                           </li>
                           <li class="listitem">
                              <p class="para">Non-element nodes that are not any kind of text nodes
                                (specifically, text, cdata section, and entity reference) are always
                                ignored.</p>
                           </li>
                           <li class="listitem">
                              <p class="para">This indexing method ensures that node identification is not
                                sensitive to XML parser handling of whitespace text nodes, entity
                                references, and CDATA sections. For instance a parser may collapse
                                whitespace-only text nodes, or not keep text, CDATA sections, and
                                entity references as distinct nodes, or break text in multiple
                                nodes.</p>
                           </li>
                        </ol>
                     </div>
                     <p class="para">The leading step in an absolute "epubcfi" (the portion of the URI
                        preceding the fragment references an EPUB file) must start with a "/"
                        followed by an even number, which must reference the <code class="code">spine</code>
                        child element of the OPF root element (<code class="code">package</code>). The OPF file
                        traversed by the CFI must the the one specified as the default publication
                        rendition in the publication’s "META-INF/container.xml" file. That is, the
                        OPF referenced by the first <code class="code">rootfile</code> element in
                        "container.xml".</p>
                     <p class="para">A relative "epubcfi" allows one Content Document to reference another
                        Content Document within an EPUB publication – the portion of the URI
                        preceding the fragment references a Content Document. See "Relative CFI’s"
                        below. In this case, the first step must start with a "/" followed by a
                        child node number, referencing a child position within the the root element
                        of the target Content Document (for XHTML content, the reference would be to
                        the <code class="code">body</code> element).</p>
                  </div>
                  <div class="section" title="3.1.1.2 &#34;[&#34; XML ID Assertion">
                     <h5 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#d55e234">›</a> </span>3.1.1.2 "[" XML ID Assertion</h5>
                     <p class="para">Each element specified with a "/" followed by an even number may
                        optionally include the XML ID specified for the element, enclosed in square
                        brackets. If an element traversed by a step has an XML ID, the identifier
                        must be included in the step notation, within brackets square.</p>
                     <p class="para">Specification of such identifiers adds robustness to the CFI scheme. A
                        Reading System may determine that the location referenced by the CFI is not
                        the original intended location, and may use the identifier to compute the
                        set of steps that reach the desired destination in the content (see
                        "Intended Target Location Recovery" below). The cost of this added
                        robustness is that comparison (and sorting) of CFI strings may only be
                        performed after logically stripping all bracketed sub-strings (see "Sorting
                        Rules" below).</p>
                  </div>
                  <div class="section" title="3.1.1.3 &#34;!&#34; Step Indirection">
                     <h5 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#d55e241">›</a> </span>3.1.1.3 "!" Step Indirection</h5>
                     <p class="para">A step with a leading "!" means that the reference must be followed. The
                        next step must be applied starting from the target node (root element node
                        when a complete XML document is referenced). Only these specific references
                        are honored:</p>
                     <div class="itemizedlist">
                        <ul class="itemizedlist">
                           <li class="listitem">
                              <p class="para">For OPF <code class="code">itemref</code> in the <code class="code">spine</code> refers to
                                the file referenced by the href attribute of the <code class="code">item</code>
                                element in the <code class="code">manifest</code> with the given id.</p>
                           </li>
                           <li class="listitem">
                              <p class="para">For HTML <code class="code">iframe</code> and <code class="code">embed</code> elements,
                                references are defined by the src attribute</p>
                           </li>
                           <li class="listitem">
                              <p class="para">For the HTML <code class="code">object</code> element, the reference is defined
                                by the data attribute</p>
                           </li>
                           <li class="listitem">
                              <p class="para">For SVG image and use elements references are defined by the
                                xlink:href attribute</p>
                           </li>
                           <li class="listitem">
                              <p class="para">Note that this schema does not take into account hyperlinks, only
                                "embedding" references; thus, it is illegal to follow links from the
                                XHTML (or SVG) <code class="code">a</code> element.</p>
                           </li>
                        </ul>
                     </div>
                  </div>
                  <div class="section" title="3.1.1.4 &#34;:&#34; Terminating Step – Character Offset">
                     <h5 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#d55e286">›</a> </span>3.1.1.4 ":" Terminating Step – Character Offset</h5>
                     <p class="para">A terminating step with a leading ":" followed by an integer refers to a
                        character offset. For element nodes, the character offset is a UTF-16
                        codepoint index in the element's intrinsic textual value. This is zero for
                        most element nodes, except for the XHTML img element where the alt attribute
                        value is used. For text nodes or a collection of nodes, the UTF-16 codepoint
                        index is calculated after concatenating text data from all the nodes. Offset
                        is zero-based and always refers to a position between characters, so 0 means
                        before the first character, and a number equal to the total UTF-16 length
                        means after the last character. A character offset value greater than the
                        UTF-16 length of the available text must not be specified.</p>
                     <p class="para">A character offset terminating step may only be present following a "/N"
                        step. For XHTML documents, N would be even when referencing the alt text of
                        an img element, and N would be odd when referencing text in a text
                        node.</p>
                     <p class="para">No other steps may follow a character offset terminating step.</p>
                  </div>
                  <div class="section" title="3.1.1.5 &#34;~&#34; Terminating Step – Temporal Offset">
                     <h5 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#d55e295">›</a> </span>3.1.1.5 "~" Terminating Step – Temporal Offset</h5>
                     <p class="para">A terminating step with a leading "~" followed by a number means temporal
                        position for audio or video, measured in seconds.</p>
                     <p class="para">No other steps can follow a temporal offset terminating step.</p>
                  </div>
                  <div class="section" title="3.1.1.6 &#34;@&#34; Terminating Step – Spacial Offset">
                     <h5 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#d55e302">›</a> </span>3.1.1.6 "@" Terminating Step – Spacial Offset</h5>
                     <p class="para">A terminating step with a leading "@" followed by two colon-seperated
                        numbers indicates a 2D spacial position within an image or video using x and
                        y in the range "0" to "100" to represent scaled locations. The upper left is
                        "0:0" and the lower right is "100:100" regardless of the image’s native or
                        display dimensions.</p>
                     <p class="para">No other steps can follow a spacial offset terminating step.</p>
                  </div>
                  <div class="section"
                       title="3.1.1.7 &#34;~&#34; + &#34;@&#34; Terminating Step – Temporal-Spacial Offset">
                     <h5 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#d55e309">›</a> </span>3.1.1.7 "~" + "@" Terminating Step – Temporal-Spacial Offset</h5>
                     <p class="para">A temporal and a spacial position may be used together. In this case, the
                        temporal specification must precede the spacial one syntactically (.e.g.
                        "~23.5@5.75:97.6" – 23.5 seconds into a video, referencing a point in the
                        lower left of the frame).</p>
                     <p class="para">No other steps can follow a temporal-spacial position terminating
                        step.</p>
                  </div>
                  <div class="section" title="3.1.1.8 &#34;[&#34; Text Location Assertion">
                     <h5 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#d55e316">›</a> </span>3.1.1.8 "[" Text Location Assertion</h5>
                     <p class="para">For another level of added robustness, CFI may contain "text location
                        assertion". This assertion may only be present following a "character
                        offset" (":") terminating step.</p>
                     <p class="para">In it simplest form it contains a substring preceding the encountered
                        point. For example, the following expression asserts that "bbb" is expected
                        to be right before the encountered point.</p>
                     <div class="informalexample">
                        <pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[bbb])</pre>
                     </div>
                     <p class="para">An additional substring that follows the encountered point can be given
                        after comma. For example:</p>
                     <div class="informalexample">
                        <pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[aa,b])</pre>
                     </div>
                     <p class="para">refers to the same position as the earlier one, marked by the
                        asterisk:</p>
                     <div class="informalexample">
                        <pre class="synopsis">
a a a b b b 0 1 2 3 4 5 6 7 8 9
| | | * | | | | | | | | | | | | |</pre>
                     </div>
                     <p class="para">There is no particular restriction on the amount of the preceding and
                        following text included in the text match. Text is taken from the document
                        ignoring element boundaries. Whitespace is always collapsed, in other words
                        a non-empty sequence of contiguous whitespace characters is always replaced
                        with a single space character. If there is no preceding text, or only
                        trailing text is specified, a text location assertion such as "[,bbb]" may
                        be used.</p>
                     <p class="para">A Reading System may determine that the location referenced by the CFI is
                        not the original intended location (due to non-matching text), and may use
                        the preceding/trailing text to compute the set of steps that reach the
                        desired destination in the content (see "Intended Target Location
                        Correction" below). The cost of this added robustness is that comparison
                        (and sorting) of CFI strings may only be performed after logically stripping
                        all bracketed sub-strings (see "Sorting Rules" below).</p>
                  </div>
                  <div class="section" title="3.1.1.9 &#34;[&#34; + &#34;;s=&#34; Side Bias">
                     <h5 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#d55e341">›</a> </span>3.1.1.9 "[" + ";s=" Side Bias</h5>
                     <p class="para">In some situations, it is important to preserve information on which side
                        of a location is desired to be referenced when it makes a difference. For
                        instance, when resolving a location in a dynamically paginated environment,
                        for some locations (e.g. right on the page break) it would make a difference
                        if a location is "glued" to the content before or after it. Side bias only
                        specifies which side of a specified location to "stick to" if there is some
                        sort of a break which falls at that location (e.g. page break or line
                        break). </p>
                     <p class="para">To preserve this information, the "s" parameter can be used. It can take
                        two values: "a" means that location is glued to the content "after" it, and
                        "b" means to the content before it. This parameter must always be used
                        inside square brackets at the very end of the CFI, even if the XML ID or
                        text location assertion is empty. For instance, given:</p>
                     <div class="informalexample">
                        <pre class="synopsis">&lt;p id="para05"&gt;aaa&lt;em&gt;bbb&lt;/em&gt;0123456789&lt;/p&gt;</pre>
                     </div>
                     <p class="para">the location just after "bbb" which is glued to the content before it can
                        be expressed as:</p>
                     <div class="informalexample">
                        <pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[;s=b])</pre>
                     </div>
                     <p class="para">or (also including a text location assertion):</p>
                     <div class="informalexample">
                        <pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[bbb;s=b])</pre>
                     </div>
                     <p class="para">Or, in this case, the location of the start of <code class="code">em</code> element,
                        using side-bias to be glued to the content just before before the
                            <code class="code">em</code> element starts:</p>
                     <div class="informalexample">
                        <pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2[;s=b])</pre>
                     </div>
                     <p class="para">If the side bias in the just-preceding example was "a", rather than "b",
                        it would glue to the content just after the <code class="code">em</code> element starts,
                        not the end of the <code class="code">em</code> element’s content (i.e. excluding the
                        possibility of any generated content, stick to the leading "b").</p>
                     <p class="para">Note that since side bias is expressed as a parameter, it does not
                        participate in CFI comparison (see "Sorting Rules" below).</p>
                     <p class="para">Side is not defined for locations with spacial terminus.</p>
                  </div>
               </div>
               <div class="section" title="3.1.2 Example">
                  <h4 class="title">
                     <span class="link-marker">
                        <a class="hidden-reveal" title="Link here" href="#d55e385">›</a> </span>3.1.2 Example</h4>
                  <p class="para">In the example above, if the OPF file looks like this:</p>
                  <div class="informalexample">
                     <pre class="synopsis">&lt;?xml version="1.0"?&gt;

&lt;package version="2.0" unique-identifier="bookid" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns="http://www.idpf.org/2007/opf" xmlns:opf="http://www.idpf.org/2007/opf"&gt;
    
    &lt;metadata&gt;
        &lt;dc:title&gt;...&lt;/dc:title&gt;
        &lt;dc:identifier id="bookid"&gt;...&lt;/dc:identifier&gt;
        &lt;dc:creator&gt;...&lt;/dc:creator&gt;
        &lt;dc:language&gt;en&lt;/dc:language&gt;
    &lt;/metadata&gt;
    
    &lt;manifest&gt;
        &lt;item properties="nav" id="toc" href="toc.xhtml" media-type="application/xhtml+xml"/&gt;
        &lt;item id="titlepage" href="titlepage.xhtml" media-type="application/xhtml+xml"/&gt;
        &lt;item id="chapter01" href="chapter01.xhtml" media-type="application/xhtml+xml"/&gt;
        &lt;item id="chapter02" href="chapter02.xhtml" media-type="application/xhtml+xml"/&gt;
        &lt;item id="chapter03" href="chapter03.xhtml" media-type="application/xhtml+xml"/&gt;
        &lt;item id="chapter04" href="chapter04.xhtml" media-type="application/xhtml+xml"/&gt;
    &lt;/manifest&gt;
    
    &lt;spine&gt;
        &lt;itemref id="titleref"  idref="titlepage"/&gt;
        &lt;itemref id="chap01ref" idref="chapter01"/&gt;
        &lt;itemref id="chap02ref" idref="chapter02"/&gt;
        &lt;itemref id="chap03ref" idref="chapter03"/&gt;
        &lt;itemref id="chap04ref" idref="chapter04"/&gt;
    &lt;/spine&gt;
    
&lt;/package&gt;
</pre>
                  </div>
                  <p class="para">and chapter01.xhtml like this:</p>
                  <div class="informalexample">
                     <pre class="synopsis">&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
    &lt;head&gt;
        &lt;title&gt;...&lt;/title&gt;
    &lt;/head&gt;
    
    &lt;body id="body01"&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p id="para05"&gt;aaa&lt;em&gt;bbb&lt;/em&gt;0123456789&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        
        &lt;img id="svgimg" src="foo.svg" alt="..."/&gt;
        
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
                  </div>
                  <p class="para">Then the initial example fragment identifier:</p>
                  <div class="informalexample">
                     <pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/3:10)</pre>
                  </div>
                  <p class="para">refers to the position right after the digit 9. When producing CFIs for text
                    locations, unless the text is defined by an img element's alt tag, one should
                    always start with the text node or text node collection (even if empty) that
                    corresponds to the location and then trace the ancestor and reference chain to
                    the OPF file root.</p>
                  <p class="para">Here are some examples:</p>
                  <div class="informalexample">
                     <p class="para">img element</p>
                     <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/16[svgimg])</pre>
                  </div>
                  <div class="informalexample">
                     <p class="para"> location just before aaa</p>
                     <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/1:0)</pre>
                  </div>
                  <div class="informalexample">
                     <p class="para"> location just before bbb</p>
                     <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:0)</pre>
                  </div>
                  <div class="informalexample">
                     <p class="para"> location just after bbb</p>
                     <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3)</pre>
                  </div>
               </div>
               <div class="section" title="3.1.3 Sorting Rules">
                  <h4 class="title">
                     <span class="link-marker">
                        <a class="hidden-reveal" title="Link here" href="#d55e428">›</a> </span>3.1.3 Sorting Rules</h4>
                  <p class="para">In order to sort or compute relative locations of multiple EPUB CFI’s
                    referencing the same publication, the following rules must be followed:</p>
                  <div class="orderedlist">
                     <ol class="orderedlist">
                        <li class="listitem">
                           <p class="para">The "URI un-escaped" core path is used</p>
                        </li>
                        <li class="listitem">
                           <p class="para">All bracketed annotations are removed or ignored entirely</p>
                        </li>
                        <li class="listitem">
                           <p class="para">Steps that come earlier in the sequence are more important</p>
                        </li>
                        <li class="listitem">
                           <p class="para">XML child nodes, character offsets and temporal positions are sorted
                            in natural order</p>
                        </li>
                        <li class="listitem">
                           <p class="para">The y position is more important than x</p>
                        </li>
                        <li class="listitem">
                           <p class="para">Omitted spacial position precedes all other spacial positions</p>
                        </li>
                        <li class="listitem">
                           <p class="para">Omitted temporal position precedes all other temporal positions</p>
                        </li>
                        <li class="listitem">
                           <p class="para">Temporal position is more important than spacial</p>
                        </li>
                        <li class="listitem">
                           <p class="para">Different step types come in the following order from least important
                            to most important: character offset (":"), child ("/"), temporal-spacial
                            ("~" or "@"), reference/indirect ("!’).</p>
                        </li>
                     </ol>
                  </div>
               </div>
               <div class="section" title="3.1.4 Relative CFI’s">
                  <h4 class="title">
                     <span class="link-marker">
                        <a class="hidden-reveal" title="Link here" href="#d55e461">›</a> </span>3.1.4 Relative CFI’s</h4>
                  <p class="para">A CFI can also be used to cross-reference XML content inside the EPUB package.
                    In that case, a relative reference to a particular resource in the spine could
                    be given (as usual), followed by a CFI which must be resolved starting from the
                    document root element. For instance, chapter02.xhtml might give a reference to
                    the last location in the previous example like this:</p>
                  <div class="informalexample">
                     <pre class="synopsis">&lt;a href="chapter01.xhtml#epubcfi(/4[body01]/10[para05]/2/1:3b)"&gt;location&lt;/a&gt;</pre>
                  </div>
               </div>
               <div class="section" title="3.1.5 Simple Ranges">
                  <h4 class="title">
                     <span class="link-marker">
                        <a class="hidden-reveal" title="Link here" href="#d55e469">›</a> </span>3.1.5 Simple Ranges</h4>
                  <p class="para">EPUB CFI provides for simple ranges extending from a start location to an end
                    location. Rather than simply stating start and finish, a range is expressed as a
                    parent path followed by a start subpath and a end subpath.</p>
                  <p class="para">An path prefix is a prefix of a path ending at a step that is common for the
                    path of the start and end locations of the range. A local subpath is a suffix of
                    a start and end paths consisting of zero or more steps to a terminus.</p>
                  <p class="para">A range is a pair of locations in non-decreasing order. A range description
                    (often just called a "range") is a triple, (P,S,E) where P is a path prefix, S
                    is a local subpath and E is a local subpath, and the pair of concatenations
                    (PS,PE) specify a range (two locations in non-decreasing order).</p>
                  <p class="para">The range from PS to PE is represented as:</p>
                  <div class="informalexample">
                     <pre class="synopsis">#epubcfi(P,S,E)</pre>
                  </div>
                  <p class="para">Ranges are compared according to the PS, then PE, components.</p>
                  <p class="para">Using sample document above this range represents text from the second b in
                    "bbb" to (and including) digit "3":</p>
                  <div class="informalexample">
                     <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05],/2/1:1,/3:4)</pre>
                  </div>
                  <p class="para">Note that it is incorrect to use a path to an element as a shorthand for the
                    range from the beginning to the end of the element. Single path notation always
                    denotes a location point and range is represented by the notation described
                    above. There is no special step to procude a reference to the end of an element
                    as that would make sorting impossible without consulting the content of the
                    document.</p>
                  <p class="para">If range is used where single location is expected by the context, the start
                    location must be used.</p>
                  <p class="para">Side-bias parameters must not be used for ranges; the start of a range is
                    implicitly glued to the content after the start location, and the end is
                    implicitly glued to the content before the end location.</p>
               </div>
               <div class="section" title="3.1.6 Intended Target Location Correction">
                  <h4 class="title">
                     <span class="link-marker">
                        <a class="hidden-reveal" title="Link here" href="#d55e497">›</a> </span>3.1.6 Intended Target Location Correction</h4>
                  <p class="para">An EPUB may be updated, corrected, or otherwise slightly altered over time; it
                    is useful to derive an EPUB CFI for the modified document from one that targeted
                    a previous version of that publication. EPUB CFI provides two mechanisms and an
                    extension architecture (see "Rules for Extensions" below) to detect and adapt to
                    content changes that impact CFI’s: XML ID and Text Location assertions.</p>
                  <p class="para">When a Reading System is processing a CFI, it should check the correctness of
                    any encountered assertions. For example, given "/6/4[chap01ref]!...", when
                    processing element "4", an <code class="code">itemref</code> in the <code class="code">spine</code>, the
                    Reading System should verify that the element has the XML ID matching
                    "chap01ref". If not, the Reading System should locate the XML ID "chap01ref"
                    within the document and "correct" the CFI (e.g. if a new <code class="code">itemref</code>
                    was inserted before the "chap01ref" <code class="code">itemref</code>, the desired element
                    number would now be "6" rather than "4", and the corrected CFI would be
                    "/6/6[chap01ref]!..."). Likewise, text location assertions should be used to
                    check referenced target locations, and used to derive a corrected CFI that
                    targets the desired text location.</p>
                  <p class="para">If one of the assertions fails during processing, and a corrected CFI can not
                    be derived (XML ID not found in the document, or text matches could not be
                    found), the CFI must be considered an invalid reference. In cases where a
                    Reading System can not check for correctness (e.g. document-resident XML IDs are
                    not available at CFI processing time), a Reading System must ignore the CFI
                    assertions.</p>
                  <p class="para">This notion of "correcting" CFI’s can lead to circumstances where two
                    different CFI’s point to the same location (i.e. the "stale" CFI,
                    pre-correction, and the corrected CFI). The corrected CFI should be used where
                    possible. A Reading System and any surrounding content management system should
                    attempt to replace stale CFI’s with their corrected versions where
                    possible.</p>
               </div>
               <div class="section" title="3.1.7 Rules for Extensions">
                  <h4 class="title">
                     <span class="link-marker">
                        <a class="hidden-reveal" title="Link here" href="#d55e521">›</a> </span>3.1.7 Rules for Extensions</h4>
                  <p class="para">It is premature, if not impossible, to know which additional heuristics will
                    be useful and reliable for CFI verification and correction (in addition to the
                    currently provided XML ID and text location assertions). The provision for such
                    extensions (CSV parameter lists, prefixed by an parameter name, and separated by
                    semicolons) allow Reading Systems to apply new or experimental heuristics to
                    assist migrating EPUB CFI fragments to updated documents. Future versions of
                    this specification may define additional parameter names. Implementations must
                    ignore all parameters that they do not understand or cannot parse.</p>
                  <p class="para">It is recommended that any vendor-specific parameter names start with "vnd."
                    followed by the vendor name.</p>
                  <p class="para">For a sake of example, one heuristic often applied when using XPointers is to
                    overcome whitespace jitter by searching for the nth instance of a substring, in
                    the hope that no identical substrings were introduced or removed when the
                    document changed. The introduction of intervening whitespace (due to parser
                    variations) or of minor edits may push the pattern around, but the intended
                    location will be tracked by the text location assertion.</p>
                  <p class="para">The XPointer string-range function supports obtaining a character position
                    based on an offset from the nth instance (if any) of a given string. A simple
                    possible extension for EPUB CFI would be to specify an offset from the nth
                    instance of a search string (defaulting to 0 on failure):</p>
                  <div class="informalexample">
                     <pre class="synopsis">";nth=" searchString [ "," searchInstance [ "," searchOffset ] ] </pre>
                  </div>
                  <p class="para">When migrating EPUB CFI references to a revised document, the Reading System
                    may recognize such an extension and attempt to correct the target location
                    accordingly.</p>
               </div>
            </div>
         </div>
         <div class="bibliography" title="References" id="references">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <span class="link-marker">
                           <a class="hidden-reveal" title="Link here" href="#references">›</a> </span>References</h2>
                  </div>
               </div>
            </div>
            <div class="bibliodiv" title="Normative References">
               <h3 class="title">Normative References</h3>
               <div class="biblioentry"
                    title="Key words for use in RFCs to Indicate Requirement Levels (RFC 2119)"
                    id="refRFC2119">
                  <p>[<abbr class="abbrev">RFC2119</abbr>] <span class="title">
                        <em>
                           <a class="link" href="http://www.ietf.org/rfc/rfc2119.txt">Key words for use in RFCs to
                    Indicate Requirement Levels</a> (RFC 2119) </em>. </span>
                     <span class="date">March 1997. </span>
                  </p>
               </div>
            </div>
         </div>
      </div>
   </body>
</html>
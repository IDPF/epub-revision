<?xml version="1.0" encoding="UTF-8"?><html xmlns="http://www.w3.org/1999/xhtml"><head><title>EPUB Canonical Fragment Identifier (epubcfi) Specification</title><link rel="stylesheet" type="text/css" href="../../css/epub-spec.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/><meta name="description" content="This specification defines a standardized method for referencing arbitrary content within an EPUB 3 Publication through the use of fragment identifiers."/><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" href="../../css/epub-print.css" type="text/css" media="print"/></head><body><div class="book" title="EPUB Canonical Fragment Identifier (epubcfi) Specification"><h1 class="title">EPUB Canonical Fragment Identifier (epubcfi) Specification</h1><p class="identity"><span class="releaseinfo">Working Group Draft</span> <span class="pubdate">29 April 2011</span></p><dl class="printhistory"><dt>This version</dt><dd>
                    <a class="link" href="http://www.idpf.org/epub/linking/20110429/epub-linking.html">http://www.idpf.org/epub/linking/20110429/epub-linking.html</a>
                </dd><dt>Latest version</dt><dd>
                    <a class="link" href="http://www.idpf.org/epub/linking/epub-linking.html">http://www.idpf.org/epub/linking/epub-linking.html</a>
                </dd><dt>Previous version</dt><dd>N/A</dd><dt>Diffs to previous version</dt><dd>N/A</dd></dl><div class="legal"><p class="copyright">Copyright © 2011 International Digital Publishing Forum™</p><div class="legalnotice" title="Legal Notice"><a id="d55e39"/><p class="para">All rights reserved. This work is protected under Title 17 of the United States Code.
        Reproduction and dissemination of this work with changes is prohibited except with the
        written permission of the <a class="link" href="http://www.idpf.org">International Digital
        Publishing Forum (IDPF)</a>.</p><p class="para">EPUB is a registered trademark of the International Digital Publishing Forum.</p></div></div><div class="authorgroup"><p class="bridgehead">Editors</p><p class="editor">Peter Sorotokin, 
                        Adobe
                    </p><p class="editor">Garth Conboy, 
                        Google Inc.
                    </p></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="chapter"><a href="#sec-overview">1. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#sec-overview-purpose-and-scope">1.1. Purpose and Scope</a></span></dt><dt><span class="section"><a href="#sec-terminology">1.2. Terminology</a></span></dt><dt><span class="section"><a href="#sec-conformance">1.3. Conformance Statements</a></span></dt></dl></dd><dt><span class="chapter"><a href="#sec-epubcfi-def">2. EPUB CFI Definition</a></span></dt><dd><dl><dt><span class="section"><a href="#sec-epubcfi-intro">2.1. Introduction</a></span></dt><dt><span class="section"><a href="#sec-epubcfi-syntax">2.2. Syntax</a></span></dt></dl></dd><dt><span class="chapter"><a href="#sec-epubcfi-processing">3. EPUB CFI Processing</a></span></dt><dd><dl><dt><span class="section"><a href="#sec-path-res">3.1. Path Resolution</a></span></dt><dd><dl><dt><span class="section"><a href="#sec-path-child-ref">3.1.1. Step Reference to Child Node (<code class="literal">/</code>)</a></span></dt><dt><span class="section"><a href="#sec-path-xmlid">3.1.2. XML ID Assertion (<code class="literal">[</code>)</a></span></dt><dt><span class="section"><a href="#sec-path-indirection">3.1.3. Step Indirection (<code class="literal">!</code>)</a></span></dt><dt><span class="section"><a href="#sec-path-terminating-char">3.1.4. Terminating Step – Character Offset (<code class="literal">:</code>)</a></span></dt><dt><span class="section"><a href="#sec-path-terminating-temporal">3.1.5. Terminating Step – Temporal Offset (<code class="literal">~</code>)</a></span></dt><dt><span class="section"><a href="#sec-path-terminating-spatial">3.1.6. Terminating Step – Spatial Offset (<code class="literal">@</code>)</a></span></dt><dt><span class="section"><a href="#sec-path-terminating-tempspatial">3.1.7. Terminating Step – Temporal-Spatial Offset (<code class="literal">~</code> +
                        <code class="literal">@</code>)</a></span></dt><dt><span class="section"><a href="#sec-path-text-location">3.1.8. Text Location Assertion (<code class="literal">[</code>)</a></span></dt><dt><span class="section"><a href="#sec-path-side-bias">3.1.9. Side Bias (<code class="literal">[</code> + <code class="literal">;s=</code>)</a></span></dt><dt><span class="section"><a href="#sec-path-examples">3.1.10. Examples</a></span></dt></dl></dd><dt><span class="section"><a href="#sec-sorting">3.2. Sorting Rules</a></span></dt><dt><span class="section"><a href="#sec-intra-cfis">3.3. Intra-Publication CFIs</a></span></dt><dt><span class="section"><a href="#sec-ranges">3.4. Simple Ranges</a></span></dt><dt><span class="section"><a href="#sec-target-correction">3.5. Intended Target Location Correction</a></span></dt></dl></dd><dt><span class="chapter"><a href="#sec-extensions">4. Extending EPUB CFIs</a></span></dt><dt><span class="bibliography"><a href="#references">References</a></span></dt></dl></div><div class="chapter" title="1 Overview" id="sec-overview"><h2 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-overview">›</a> </span>1 Overview</h2><div class="section" title="1.1 Purpose and Scope" id="sec-overview-purpose-and-scope"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-overview-purpose-and-scope">›</a> </span>1.1 Purpose and Scope</h3><p class="para" id="sibling-specs">This specification, EPUB Canonical Fragment Identifier
                (epubcfi), defines a standardized method for referencing arbitrary content within an
                    <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB® 3 Publication</a> through the
                use of fragment identifiers. </p><p class="para">The Web has proven that the concept of hyperlinking is tremendously powerful, but
                EPUB Publications have been denied much of the benefit that hyperlinking makes
                possible because of the lack of a standardized scheme to link into them. Although
                proprietary schemes have been developed and implemented for individual <a class="glossterm" href="#gloss-epub-reading-system" title="EPUB Reading System (or Reading System)">EPUB Reading System</a>s, without a commonly-understood syntax
                there has been no way to achieve cross-platform interoperability. The functionality
                that can see significant benefit from breaking down this barrier, however, is
                varied: from reading location maintenance to annotation attachment to navigation,
                the ability to point into any Publication opens a whole new dimension not previously
                available to developers and <a class="glossterm" href="#gloss-author" title="Author">Author</a>s. </p><p class="para">This specification attempts to rectify this situation by defining an arbitrary
                structural reference that can uniquely identify any location, or simple range of
                locations, in a Publication: the EPUB CFI. The following considerations have
                strongly influenced the design and scope of this scheme:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="para">The mechanism used to reference content should be interoperable:
                        references to a reading position created by one Reading System should be
                        usable by another.</p></li><li class="listitem"><p class="para">Document references to EPUB content should be enabled in the same way that
                        existing hyperlinks enable references throughout the Web.</p></li><li class="listitem"><p class="para">Each location in an EPUB file should be able to be identified without the
                        need to modify the document.</p></li><li class="listitem"><p class="para">All fragment identifiers that reference the same logical location should
                        be equal when compared.</p></li><li class="listitem"><p class="para">Comparison operations, including tests for sorting and comparison, should
                        be able to be performed without accessing the referenced files.</p></li><li class="listitem"><p class="para">Simple manipulations should be possible without access to the original
                        files (e.g., given a reference deep in a file, it should be possible to
                        generate a reference to the start of the file).</p></li><li class="listitem"><p class="para">Identifier resolution should be reasonably efficient (e.g., processing of
                        the first chapter is not required to resolve a fragment identifier that
                        points to the last chapter).</p></li><li class="listitem"><p class="para">References should be able to recover their target locations through parser
                        variations and document revisions.</p></li><li class="listitem"><p class="para">Expression of simple, contiguous ranges should be supported.</p></li><li class="listitem"><p class="para">An extensible mechanism to accommodate future reference recovery
                        heuristics should be provided.</p></li></ul></div></div><div class="section" title="1.2 Terminology" id="sec-terminology"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-terminology">›</a> </span>1.2 Terminology</h3><div class="glosslist"><dl><dt class="glossentry" title="EPUB Publication (or Publication)" id="gloss-epub-publication">EPUB Publication (or Publication)</dt><dd><p class="para">A logical document entity consisting of a set of interrelated <a class="glossterm" href="#gloss-publication-resource-cmt-or-foreign" title="Publication Resource">resources</a> and
                packaged in an <a class="glossterm" href="#gloss-container" title="EPUB Container (or Container)">EPUB Container</a>, as defined by 
                
                <span class="phrase">the EPUB 3 specifications</span>.</p></dd><dt class="glossentry" title="Publication Resource" id="gloss-publication-resource-cmt-or-foreign">Publication Resource</dt><dd><p class="para">A resource that contains content or instructions that contribute to the logic and
                rendering of the <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a>. In the absence of this
                resource, the Publication may not render as intended by the <a class="glossterm" href="#gloss-author" title="Author">Author</a>. Examples of Publication Resources include the <a class="glossterm" href="#gloss-package-document" title="Package Document">Package Document</a>, <a class="glossterm" href="#gloss-content-document-epub" title="EPUB Content Document">EPUB Content Document</a>s, <a class="glossterm" href="#gloss-stylesheet" title="EPUB Style Sheet (or Style Sheet)">EPUB Style Sheet</a>s, audio, video, images, embedded fonts and
                scripts.</p><p class="para">With the exception of the Package Document itself, Publication Resources must be
                listed in the <span class="phrase"><a class="link" href="../../30/spec/epub30-publications.html#sec-manifest-elem">manifest</a> <a class="biblioref" href="#refPublications3" title="EPUB Publications 3.0">[<abbr class="abbrev">Publications30</abbr>]</a></span> and must be bundled in the EPUB container file
                unless specified otherwise in <span class="phrase"><a class="link" href="../../30/spec/epub30-publications.html#sec-manifest-elem">manifest</a> <a class="biblioref" href="#refPublications3" title="EPUB Publications 3.0">[<abbr class="abbrev">Publications30</abbr>]</a></span>.</p><p class="para">Examples of resources that are not Publication Resources include those identified
                by the Package document <span class="phrase"><a class="link" href="../../30/spec/epub30-publications.html#sec-manifest-elem">manifest</a> <a class="biblioref" href="#refPublications3" title="EPUB Publications 3.0">[<abbr class="abbrev">Publications30</abbr>]</a></span> element and third-party
                resources identified by outbound hyperlinks (e.g., identified in <a class="biblioref" href="#refHTML5" title="HTML5: A vocabulary and associated APIs for HTML and XHTML">[<abbr class="abbrev">HTML5</abbr>]</a>
                <code class="code">a</code> element <code class="code">href</code> attributes).</p></dd><dt class="glossentry" title="EPUB Content Document" id="gloss-content-document-epub">EPUB Content Document</dt><dd><p class="para">A <a class="glossterm" href="#gloss-publication-resource-cmt-or-foreign" title="Publication Resource">Publication Resource</a> that conforms to one
                of the EPUB Content Document definitions (<a class="glossterm" href="#gloss-content-document-epub-xhtml" title="XHTML Content Document">XHTML</a> or <a class="glossterm" href="#gloss-content-document-epub-svg" title="SVG Content Document">SVG</a>).</p><p class="para">An EPUB Content Document is a <a class="glossterm" href="#gloss-core-media-type" title="Core Media Type">Core Media Type</a>, and may
                therefore be included in the <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a> without the
                provision of 
                <span class="phrase"><a class="link" href="../../30/spec/epub30-publications.html#sec-fallback-processing-flow">fallbacks</a> <a class="biblioref" href="#refPublications3" title="EPUB Publications 3.0">[<abbr class="abbrev">Publications30</abbr>]</a></span>.</p></dd><dt class="glossentry" title="XHTML Content Document" id="gloss-content-document-epub-xhtml">XHTML Content Document</dt><dd><p class="para">An <a class="glossterm" href="#gloss-content-document-epub" title="EPUB Content Document">EPUB Content Document</a> conforming to the profile of
                    <a class="biblioref" href="#refHTML5" title="HTML5: A vocabulary and associated APIs for HTML and XHTML">[<abbr class="abbrev">HTML5</abbr>]</a> defined in 
                <span class="phrase"><a class="link" href="../../30/spec/epub30-contentdocs.html#sec-xhtml">XHTML Content Documents</a> <a class="biblioref" href="#refContentDocs3" title="EPUB Content Documents 3.0">[<abbr class="abbrev">ContentDocs30</abbr>]</a></span>.</p><p class="para">XHTML Content Documents use the <a class="link" href="http://www.w3.org/TR/html5/Overview.html#the-xhtml-syntax">XHTML
                    syntax</a> of <a class="biblioref" href="#refHTML5" title="HTML5: A vocabulary and associated APIs for HTML and XHTML">[<abbr class="abbrev">HTML5</abbr>]</a>.</p></dd><dt class="glossentry" title="SVG Content Document" id="gloss-content-document-epub-svg">SVG Content Document</dt><dd><p class="para">An <a class="glossterm" href="#gloss-content-document-epub" title="EPUB Content Document">EPUB Content Document</a> conforming to the constraints
                expressed in 
                <span class="phrase"><a class="link" href="../../30/spec/epub30-contentdocs.html#sec-svg">SVG Content Documents</a> <a class="biblioref" href="#refContentDocs3" title="EPUB Content Documents 3.0">[<abbr class="abbrev">ContentDocs30</abbr>]</a></span>.</p></dd><dt class="glossentry" title="Core Media Type" id="gloss-core-media-type">Core Media Type</dt><dd><p class="para">A set of <a class="glossterm" href="#gloss-publication-resource-cmt-or-foreign" title="Publication Resource">Publication Resource</a> types for
                which no fallback is required. Refer to 
                <span class="phrase"><a class="link" href="../../30/spec/epub30-publications.html#sec-publication-resources">Publication Resources</a> <a class="biblioref" href="#refPublications3" title="EPUB Publications 3.0">[<abbr class="abbrev">Publications30</abbr>]</a></span> for more information. </p></dd><dt class="glossentry" title="Package Document" id="gloss-package-document">Package Document</dt><dd><p class="para">A <a class="glossterm" href="#gloss-publication-resource-cmt-or-foreign" title="Publication Resource">Publication Resource</a> carrying
                bibliographical and  structural metadata about the <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a>, as defined in 
                <span class="phrase"><a class="link" href="../../30/spec/epub30-publications.html#sec-package-documents">Package Documents</a> <a class="biblioref" href="#refPublications3" title="EPUB Publications 3.0">[<abbr class="abbrev">Publications30</abbr>]</a></span>.</p></dd><dt class="glossentry" title="Standard EPUB CFI" id="gloss-cfi-pub">Standard EPUB CFI</dt><dd><p class="para">A Publication-level EPUB CFI links into an <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a>. The path 
                preceding the EPUB CFI references the location of the Publication.</p></dd><dt class="glossentry" title="Intra-Publication EPUB CFI" id="gloss-cfi-intra-pub">Intra-Publication EPUB CFI</dt><dd><p class="para">An intra-Publication EPUB CFI allows one <a class="glossterm" href="#gloss-content-document-epub" title="EPUB Content Document">EPUB Content Document</a> to reference 
                another within the same <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a>. The path preceding the
                EPUB CFI references the current Publication's <a class="glossterm" href="#gloss-package-document" title="Package Document">Package Document</a>.</p><p class="para">Refer to <a class="xref" href="#sec-intra-cfis" title="3.3 Intra-Publication CFIs">Intra-Publication CFIs</a>
                 for more information. </p></dd><dt class="glossentry" title="EPUB Style Sheet (or Style Sheet)" id="gloss-stylesheet">EPUB Style Sheet (or Style Sheet)</dt><dd><p class="para">A CSS Style Sheet conforming to the CSS profile defined in 
                <span class="phrase"><a class="link" href="../../30/spec/epub30-contentdocs.html#sec-css">EPUB Style Sheets</a> <a class="biblioref" href="#refContentDocs3" title="EPUB Content Documents 3.0">[<abbr class="abbrev">ContentDocs30</abbr>]</a></span>.</p></dd><dt class="glossentry" title="EPUB Container (or Container)" id="gloss-container">EPUB Container (or Container)</dt><dd><p class="para">A ZIP-based packaging and distribution format for <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a>s, as defined in 
                <a class="biblioref" href="#refOCF30" title="Open Container Format 3.0">[<abbr class="abbrev">OCF3</abbr>]</a>. </p></dd><dt class="glossentry" title="Author" id="gloss-author">Author</dt><dd><p class="para">The person(s) or organization responsible for the creation of an <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a>, which may or may not be the creator of the
                content and resources it contains.
                
            </p></dd><dt class="glossentry" title="User" id="gloss-user">User</dt><dd><p class="para">An individual that consumes an <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a> using an
                    <a class="glossterm" href="#gloss-epub-reading-system" title="EPUB Reading System (or Reading System)">EPUB Reading System</a>.</p></dd><dt class="glossentry" title="EPUB Reading System (or Reading System)" id="gloss-epub-reading-system">EPUB Reading System (or Reading System)</dt><dd><p class="para">A system that processes <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a>s for presentation
                to a <a class="glossterm" href="#gloss-user" title="User">User</a> in a manner conformant with 
                <span class="phrase">this specification and its <a class="link" href="#sibling-specs">sibling specifications</a></span>. </p></dd></dl></div></div><div class="section" title="1.3 Conformance Statements" id="sec-conformance"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-conformance">›</a> </span>1.3 Conformance Statements</h3><p class="para">The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
        "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as
        described in <a class="biblioref" href="#refRFC2119" title="Key words for use in RFCs to Indicate Requirement Levels (RFC 2119)">[<abbr class="abbrev">RFC2119</abbr>]</a>.</p><p class="para">All sections of this specification are normative except where identified by 
        the informative status label "This section is informative". The application of informative 
        status to sections and appendices applies to all child content and subsections 
        they may contain.</p><p class="para">All examples in this specification are informative.</p></div></div><div class="chapter" title="2 EPUB CFI Definition" id="sec-epubcfi-def"><h2 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-epubcfi-def">›</a> </span>2 EPUB CFI Definition</h2><div class="section" title="2.1 Introduction" id="sec-epubcfi-intro"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-epubcfi-intro">›</a> </span>2.1 Introduction</h3><p class="informative"> This section is informative</p><p class="para">A fragment identifier is the part of an IRI <a class="biblioref" href="#refRFC3987" title="Internationalized Resource Identifiers (IRIs) (RFC 3987)">[<abbr class="abbrev">RFC3987</abbr>]</a> that defines a location within a
                resource. Syntactically, it is the segment attached to the of end the resource IRI
                starting with a hash (<code class="literal">#</code>). For HTML documents, IDs and named
                anchors are used as fragment identifiers, while for XML documents the Shorthand
                XPointer <a class="biblioref" href="#refXPTRSH" title="XPointer Shorthand Notation">[<abbr class="abbrev">XPTRSH</abbr>]</a> notation is used to refer to a given ID.</p><p class="para">A Canonical Fragment Identifier (CFI) is a similar construct to these, but
                expresses a location within an <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a>. For example:</p><div class="informalexample"><pre class="synopsis">demo.epub#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/3:10)</pre></div><p class="para">The function-like string immediately following the hash
                    (<code class="literal">epubcfi(…)</code>) indicates that this fragment identifier conforms
                to the scheme defined by this specification, and the value contained in the
                parentheses is the syntax used to reference the location within the
                specified Publication (<code class="filename">demo.epub</code>). Using the processing rules
                defined in <a class="xref" href="#sec-path-res" title="3.1 Path Resolution">Path Resolution</a>, any <a class="glossterm" href="#gloss-epub-reading-system" title="EPUB Reading System (or Reading System)">EPUB Reading System</a> 
                can parse this syntax,
                open the corresponding <a class="glossterm" href="#gloss-content-document-epub" title="EPUB Content Document">EPUB Content Document</a> in the Publication 
                and load the specified location for the <a class="glossterm" href="#gloss-user" title="User">User</a>.</p><p class="para">A complete definition of the EPUB CFI syntax is provided in the next
                section.</p><div class="note" title="note"><h3 class="title">note</h3><p class="para"><code class="literal">epub</code> has been prepended to the name of the scheme as a more
                    generic CFI-like scheme may be defined in the future for all XML+ZIP-based file
                    formats.</p></div></div><div class="section" title="2.2 Syntax" id="sec-epubcfi-syntax"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-epubcfi-syntax">›</a> </span>2.2 Syntax</h3><table width="100%" cellpadding="0" border="0" style="background-color: #EEE" class="productionset" summary="EBNF productions for The EPUB Canonical Fragment Identifier (CFI) Syntax"><caption>(EBNF productions <a href="http://www.iso.org/iso/iso_catalogue/catalogue_tc/catalogue_detail.htm?csnumber=26153">ISO/IEC 14977</a>)</caption><tr><td align="right" valign="top" id="epubcfi.ebnf.fragment"><a href="#epubcfi.ebnf.fragment">fragment</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        "epubcfi(" , (
                        <a href="#epubcfi.ebnf.path">path</a>
                        |
                        <a href="#epubcfi.ebnf.range">range</a>
                        ) , ")"
                        
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.path"><a href="#epubcfi.ebnf.path">path</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        <a href="#epubcfi.ebnf.step">step</a>
                        ,
                        <a href="#epubcfi.ebnf.local_path">local_path</a>
                        
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.range"><a href="#epubcfi.ebnf.range">range</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        <a href="#epubcfi.ebnf.path">path</a>
                        ,
                        ","
                        ,
                        <a href="#epubcfi.ebnf.local_path">local_path</a>
                        ,
                        ","
                        ,
                        <a href="#epubcfi.ebnf.local_path">local_path</a>
                        
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.local_path"><a href="#epubcfi.ebnf.local_path">local_path</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        {
                        <a href="#epubcfi.ebnf.step">step</a>
                        | "!" } , [ 
                        <a href="#epubcfi.ebnf.termstep">termstep</a>
                        ]
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.step"><a href="#epubcfi.ebnf.step">step</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        "/" ,
                        <a href="#epubcfi.ebnf.integer">integer</a>
                        , [ "[" , 
                        <a href="#epubcfi.ebnf.assertion">assertion</a>
                        , "]" ]
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.termstep"><a href="#epubcfi.ebnf.termstep">termstep</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        <a href="#epubcfi.ebnf.terminus">terminus</a>
                        ,
                        [ "[" , 
                        <a href="#epubcfi.ebnf.assertion">assertion</a>
                        , "]" ] 
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.terminus"><a href="#epubcfi.ebnf.terminus">terminus</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        (":" ,
                        <a href="#epubcfi.ebnf.integer">integer</a>
                        ) | ("@" , 
                        <a href="#epubcfi.ebnf.number">number</a>
                        , ":" , 
                        <a href="#epubcfi.ebnf.number">number</a>
                        ) | ("~" ,
                        <a href="#epubcfi.ebnf.number">number</a>
                        ) | ("~" ,
                        <a href="#epubcfi.ebnf.number">number</a>
                        , "@" ,
                        <a href="#epubcfi.ebnf.number">number</a>
                        , ":" , 
                        <a href="#epubcfi.ebnf.number">number</a>
                        )
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.number"><a href="#epubcfi.ebnf.number">number</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        (
                        <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a>
                        , { 
                        <a href="#epubcfi.ebnf.digit">digit</a>
                        }
                        , [ "." , { 
                        <a href="#epubcfi.ebnf.digit">digit</a>
                        } ,
                        <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a>
                        ] ) | (
                        <a href="#epubcfi.ebnf.zero">zero</a>
                        , "." , { 
                        <a href="#epubcfi.ebnf.digit">digit</a>
                        } , 
                        <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a>
                        )
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.integer"><a href="#epubcfi.ebnf.integer">integer</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        <a href="#epubcfi.ebnf.zero">zero</a>
                        | (
                        <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a>
                        , { 
                        <a href="#epubcfi.ebnf.digit">digit</a>
                        })
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.assertion"><a href="#epubcfi.ebnf.assertion">assertion</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        [
                        <a href="#epubcfi.ebnf.csv">csv</a>
                        ] , {
                        <a href="#epubcfi.ebnf.parameter">parameter</a>
                        }
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.parameter"><a href="#epubcfi.ebnf.parameter">parameter</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        ";" ,
                        <a href="#epubcfi.ebnf.string-no-special-chars">string-no-special-chars</a>
                        , "=" ,
                        <a href="#epubcfi.ebnf.csv">csv</a>
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.csv"><a href="#epubcfi.ebnf.csv">csv</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        <a href="#epubcfi.ebnf.value">value</a>
                        , { "," ,
                        <a href="#epubcfi.ebnf.value">value</a>
                        }
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.value"><a href="#epubcfi.ebnf.value">value</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        <a href="#epubcfi.ebnf.string-no-special-chars">string-no-special-chars</a>
                        | ('"' ,
                        <a href="#epubcfi.ebnf.string">string</a>
                        , '"')
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.string"><a href="#epubcfi.ebnf.string">string</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        <a href="#epubcfi.ebnf.character">character</a>
                        ,
                        { 
                        <a href="#epubcfi.ebnf.character">character</a>
                        }
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.string-no-special-chars"><a href="#epubcfi.ebnf.string-no-special-chars">string-no-special-chars</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        <a href="#epubcfi.ebnf.string">string</a>
                        -
                        (
                        <a href="#epubcfi.ebnf.double-quote">double-quote</a>
                        | 
                        <a href="#epubcfi.ebnf.square-brackets">square-brackets</a>
                        | 
                        <a href="#epubcfi.ebnf.parentheses">parentheses</a>
                        | 
                        <a href="#epubcfi.ebnf.comma">comma</a>
                        | 
                        <a href="#epubcfi.ebnf.semicolon">semicolon</a>
                        )
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.digit"><a href="#epubcfi.ebnf.digit">digit</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        <a href="#epubcfi.ebnf.zero">zero</a>
                        |
                        <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a>
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.digit-non-zero"><a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9"
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.zero"><a href="#epubcfi.ebnf.zero">zero</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        "0"
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.backslash"><a href="#epubcfi.ebnf.backslash">backslash</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        "\"
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.double-quote"><a href="#epubcfi.ebnf.double-quote">double-quote</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        '"'
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.square-brackets"><a href="#epubcfi.ebnf.square-brackets">square-brackets</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        "[" | "]"
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.parentheses"><a href="#epubcfi.ebnf.parentheses">parentheses</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        "(" | ")"
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.comma"><a href="#epubcfi.ebnf.comma">comma</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        ","
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.semicolon"><a href="#epubcfi.ebnf.semicolon">semicolon</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        ";"
                    ;</td></tr><tr><td align="right" valign="top" id="epubcfi.ebnf.character"><a href="#epubcfi.ebnf.character">character</a></td><td valign="top" align="center"><code>=</code></td><td valign="top">
                        ? UNICODE-CHAR ?
                    ;</td></tr></table><p class="para">A Canonical Fragment Identifier (CFI) consists of an initial sequence
                    <code class="literal">epubcfi</code> that identifies this particular reference method, and
                a parenthesized path or range. A path is built up as a sequence of structural steps
                to reference a location. A range is a path followed by two local (or relative) paths
                that identify the start and end of the range.</p><p class="para">Steps can either be navigational or terminating. Navigational steps may be
                repeated as necessary (e.g., to count elements, to process children or to follow
                references). There may be only one terminating step, which, if present, must be the
                last step in the sequence. </p><p class="para">Substrings in brackets are extensible assertions that improve the robustness of
                traversing paths and migrating them from one revision of the document to another.
                These assertions preserve additional information about traversed elements of the
                document, which makes it possible to recover intended location even after some
                modifications are made to the Publication.</p><p class="para">The <code class="literal">value</code> definition in the syntax above can either be a quoted
                string (delimited by quote characters (<code class="literal">"</code>)) or a sequence of
                characters. The following characters must only appear in a quoted string, however,
                as they would otherwise interfere with parsing:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="para">quote (<code class="literal">"</code>)</p></li><li class="listitem"><p class="para">brackets (<code class="literal">[</code>,<code class="literal">]</code>)</p></li><li class="listitem"><p class="para">parentheses (<code class="literal">(</code>,<code class="literal">)</code>)</p></li><li class="listitem"><p class="para">comma (<code class="literal">,</code>)</p></li><li class="listitem"><p class="para">semicolon (<code class="literal">;</code>)</p></li></ul></div><p class="para">Quote and backslash characters (<code class="literal">\</code>) contained within a quoted
            string must be escaped by adding a single backslash character before them.</p><div class="informalexample"><p class="para">Example of an EPUB CFI that points a location after the text <code class="literal">"c:\" drive</code>.</p><pre class="synopsis">#epubcfi(/6/7[chap05ref]!/4[body01]/10/2/1:3["\"c:\\\" drive"])</pre></div><p class="para">The following rules apply to the use of numbers and integers within the path or
                range:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="para">leading zeros are not allowed for numbers or integers (to ensure
                        uniqueness);</p></li><li class="listitem"><p class="para">trailing zeros are not allowed in the fractional part of a number;</p></li><li class="listitem"><p class="para">zero must be represented as the integer <code class="literal">0</code>;</p></li><li class="listitem"><p class="para">numbers in the range <code class="literal">1 &gt; N &gt; 0</code> must have a leading
                            <code class="literal">0.</code>;</p></li><li class="listitem"><p class="para">integral numbers must be represented as integers.</p></li></ul></div><p class="para">When an EPUB CFI is used as a part of IRI <a class="biblioref" href="#refRFC3987" title="Internationalized Resource Identifiers (IRIs) (RFC 3987)">[<abbr class="abbrev">RFC3987</abbr>]</a>, it must 
                be escaped as per that specification. When extracting from an IRI, it must be unescaped
                prior to parsing, sorting or comparing.</p></div></div><div class="chapter" title="3 EPUB CFI Processing" id="sec-epubcfi-processing"><h2 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-epubcfi-processing">›</a> </span>3 EPUB CFI Processing</h2><div class="section" title="3.1 Path Resolution" id="sec-path-res"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-res">›</a> </span>3.1 Path Resolution</h3><p class="para">The process of resolving an EPUB CFI to a location within an 
                <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a> begins with
                the root  <code class="code">package</code> 
                element of the <a class="glossterm" href="#gloss-package-document" title="Package Document">Package Document</a>. Each step in the CFI
                is then processed one by one, left to right, applying the rules defined in the
                following subsections.</p><div class="note" title="note"><h3 class="title">note</h3><p class="para">The EPUB CFI examples in the following subsections are based on the 
                    sample documents in <a class="xref" href="#sec-path-examples" title="3.1.10 Examples">Examples</a>.</p></div><div class="section" title="3.1.1 Step Reference to Child Node (/)" id="sec-path-child-ref"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-child-ref">›</a> </span>3.1.1 Step Reference to Child Node (<code class="literal">/</code>)</h4><p class="para">A step with a slash (<code class="literal">/</code>) followed by an integer refers to a
                    child node or nodes in the following manner:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="para">Each element is assigned an <span class="emphasis"><em>even</em></span> positive index:
                            the first element is given index <code class="literal">2</code>, the second
                            element index <code class="literal">4</code>, etc.</p></li><li class="listitem"><p class="para">Each (possibly empty) collection of non-element nodes before the first
                            element, between elements, and after the last element are given
                                <span class="emphasis"><em>odd</em></span> indices according to their position (these
                            typically refer to the text of the publication).</p></li><li class="listitem"><p class="para">Non-element nodes that are not text nodes are always ignored (for the
                            purposes of this specification, a text node includes text, CDATA
                            sections and entity references).</p></li></ul></div><p class="para">This indexing method ensures that node identification is not sensitive to XML
                    parser handling of whitespace text nodes, CDATA sections and entity references
                    (e.g., to avoid the ambiguity that can arise depending on whether a parser
                    collapses whitespace-only text nodes, keeps text, CDATA sections and entity
                    references as distinct nodes or doesn't, or breaks text in multiple
                    nodes).</p><p class="para">For a <a class="glossterm" href="#gloss-cfi-pub" title="Standard EPUB CFI">Standard EPUB CFI</a>,
                    the leading step in the CFI must start with a slash (<code class="literal">/</code>)
                    followed by an even number that references the <code class="code">spine</code> child element
                    of the <a class="glossterm" href="#gloss-package-document" title="Package Document">Package Document</a>'s root <code class="code">package</code> 
                    element. The Package Document traversed by the CFI
                    must be the one specified as the default rendition in the Publication's
                        <code class="filename">META-INF/container.xml</code> file (i.e., the Package Document referenced
                    by the first <code class="code">rootfile</code> element in
                    <code class="filename">container.xml</code>).</p><p class="para">For an <a class="glossterm" href="#gloss-cfi-intra-pub" title="Intra-Publication EPUB CFI">Intra-Publication EPUB CFI</a>, 
                    the first step must start with a 
                    slash followed by a node number that references a position in Package Document
                    starting from the root <code class="code">package</code> 
                    element.</p></div><div class="section" title="3.1.2 XML ID Assertion ([)" id="sec-path-xmlid"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-xmlid">›</a> </span>3.1.2 XML ID Assertion (<code class="literal">[</code>)</h4><p class="para">When an EPUB CFI references an element that contains an ID <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a>, 
                    the corresponding path step must include that ID in square brackets 
                    (i.e., after the slash (<code class="literal">/</code>) and even number that identifies 
                    the element).</p><p class="para">Specification of identifiers adds robustness to the CFI scheme: a Reading
                    System may determine that the location referenced by the CFI is not the original
                    intended location, and may use the identifier to compute the set of steps that
                    reach the desired destination in the content (see <a class="xref" href="#sec-target-correction" title="3.5 Intended Target Location Correction">Intended Target Location Correction</a>). The cost of this added robustness is
                    that comparison (and sorting) of CFI strings may only be performed after
                    logically stripping all bracketed substrings (see <a class="xref" href="#sec-sorting" title="3.2 Sorting Rules">Sorting Rules</a>).</p></div><div class="section" title="3.1.3 Step Indirection (!)" id="sec-path-indirection"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-indirection">›</a> </span>3.1.3 Step Indirection (<code class="literal">!</code>)</h4><p class="para">A step with a leading exclamation point (<code class="literal">!</code>) indicates that
                    the reference must be followed and the next step applied starting from the new
                    target node (or root element node when a complete XML document is
                    referenced).</p><p class="para">Only the following references are honored:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="para">For <code class="code">itemref</code> 
                            in the Package Document <code class="code">spine</code>, the reference
                            is defined by the <code class="code">href</code> attribute of the corresponding
                            <code class="code">item</code> element 
                            in the <code class="code">manifest</code> (i.e., that
                            the <code class="code">itemref</code>'s <code class="code">idref</code> attribute
                            references).</p></li><li class="listitem"><p class="para">For <a class="biblioref" href="#refHTML5" title="HTML5: A vocabulary and associated APIs for HTML and XHTML">[<abbr class="abbrev">HTML5</abbr>]</a> 
                            <code class="code"><a class="link" href="http://www.w3.org/TR/html5/Overview.html#the-iframe-element">iframe</a></code> 
                            and 
                            <code class="code"><a class="link" href="http://www.w3.org/TR/html5/Overview.html#the-embed-element">embed</a></code> 
                            elements,
                            references are defined by the <code class="code">src</code> attribute</p></li><li class="listitem"><p class="para">For the <a class="biblioref" href="#refHTML5" title="HTML5: A vocabulary and associated APIs for HTML and XHTML">[<abbr class="abbrev">HTML5</abbr>]</a> 
                            <code class="code"><a class="link" href="http://www.w3.org/TR/html5/Overview.html#the-object-element">object</a></code> 
                            element, the reference is defined by
                            the <code class="code">data</code> attribute</p></li><li class="listitem"><p class="para">For <a class="biblioref" href="#refSVG" title="Scalable Vector Graphics (SVG) 1.1 (Second Edition)">[<abbr class="abbrev">SVG</abbr>]</a> 
                            <code class="code"><a class="link" href="http://www.w3.org/TR/SVG11/struct.html#ImageElement">image</a></code>
                            and 
                            <code class="code"><a class="link" href="http://www.w3.org/TR/SVG11/struct.html#UseElement">use</a></code> 
                            elements, references
                            are defined by the <code class="code">xlink:href</code> attribute</p></li></ul></div><div class="note" title="note"><h3 class="title">note</h3><p class="para">This scheme does not take into account hyperlinks, only embedding
                        references. Consequently, it is illegal to follow links from the <a class="biblioref" href="#refHTML5" title="HTML5: A vocabulary and associated APIs for HTML and XHTML">[<abbr class="abbrev">HTML5</abbr>]</a> 
                        (or <a class="biblioref" href="#refSVG" title="Scalable Vector Graphics (SVG) 1.1 (Second Edition)">[<abbr class="abbrev">SVG</abbr>]</a>) <code class="code">a</code> element.</p></div></div><div class="section" title="3.1.4 Terminating Step – Character Offset (:)" id="sec-path-terminating-char"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-terminating-char">›</a> </span>3.1.4 Terminating Step – Character Offset (<code class="literal">:</code>)</h4><p class="para">A terminating step with a leading colon (<code class="literal">:</code>) followed by an
                    integer refers to a character offset. 
                    The given character offset may apply to an element node only if this element is the 
                    <a class="biblioref" href="#refHTML5" title="HTML5: A vocabulary and associated APIs for HTML and XHTML">[<abbr class="abbrev">HTML5</abbr>]</a> 
                    <code class="code"><a class="link" href="http://www.w3.org/TR/html5/Overview.html#the-img-element">img</a></code>
                    element with an <code class="code">alt</code> attribute containing the text to which the character 
                    offset applies.</p><p class="para">For text nodes, or a collection of
                    nodes, the offset is zero-based and always refers to a position
                    between characters, so <code class="literal">0</code> means before the first character and
                    a number equal to the total UTF-16 length means after the last character. A
                    character offset value greater than the UTF-16 length of the available text must
                    not be specified.</p><p class="para">A character offset terminating step may only be present following a
                        <code class="literal">/N</code> step. For XHTML Content Documents, <code class="literal">N</code> would
                    be an even number when referencing the <code class="code">alt</code> text of an <code class="code">img</code>
                    element, and <code class="literal">N</code> would be odd when referencing text in a text
                    node.</p><p class="para">No other steps may follow a character offset terminating step.</p></div><div class="section" title="3.1.5 Terminating Step – Temporal Offset (~)" id="sec-path-terminating-temporal"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-terminating-temporal">›</a> </span>3.1.5 Terminating Step – Temporal Offset (<code class="literal">~</code>)</h4><p class="para">A terminating step with a leading tilde (<code class="literal">~</code>) followed by a
                    number indicates a temporal position for audio or video measured in
                    seconds.</p><p class="para">No other steps can follow a temporal offset terminating step.</p></div><div class="section" title="3.1.6 Terminating Step – Spatial Offset (@)" id="sec-path-terminating-spatial"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-terminating-spatial">›</a> </span>3.1.6 Terminating Step – Spatial Offset (<code class="literal">@</code>)</h4><p class="para">A terminating step with a leading at sign (<code class="literal">@</code>) followed by
                    two colon-separated numbers indicates a 2D spatial position within an image or
                    video. The two numbers represent scaled locations in the <code class="literal">x</code>
                    and <code class="literal">y</code> axes, and must be in the range <code class="literal">0</code> to
                        <code class="literal">100</code> regardless of the image's native or display
                    dimensions (i.e., the upper left is <code class="literal">0:0</code> and the lower right
                    is <code class="literal">100:100</code>).</p><p class="para">No other steps can follow a spatial offset terminating step.</p></div><div class="section" title="3.1.7 Terminating Step – Temporal-Spatial Offset (~ + @)" id="sec-path-terminating-tempspatial"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-terminating-tempspatial">›</a> </span>3.1.7 Terminating Step – Temporal-Spatial Offset (<code class="literal">~</code> +
                        <code class="literal">@</code>)</h4><p class="para">A temporal and a spatial position may be used together. In this case, the
                    temporal specification must precede the spatial one syntactically (e.g.,
                        <code class="literal">~23.5@5.75:97.6</code> refers to a point 23.5 seconds into a
                    video in the lower left of the frame).</p><p class="para">No other steps can follow a temporal-spatial position terminating step.</p></div><div class="section" title="3.1.8 Text Location Assertion ([)" id="sec-path-text-location"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-text-location">›</a> </span>3.1.8 Text Location Assertion (<code class="literal">[</code>)</h4><p class="para">An EPUB CFI may specify a substring that should precede and/or follow the
                    encountered point, but such assertions must only occur after a <a class="link" href="#sec-path-terminating-char" title="3.1.4 Terminating Step – Character Offset (:)">character offset terminating
                    step</a>.</p><p class="para">For example, the following expression asserts that <code class="literal">yyy</code> is
                    expected immediately before the encountered point using the 
                    <a class="link" href="#sec-path-examples" title="3.1.10 Examples">sample content below</a>:</p><div class="informalexample"><pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[yyy])</pre></div><p class="para">An additional substring that follows the encountered point can be given after
                    a comma. For example:</p><div class="informalexample"><pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/1:3[xx,y])</pre></div><p class="para">refers to the position marked by the asterisk:</p><div class="informalexample"><pre class="synopsis">
x x x y y y 0 1 2 3 4 5 6 7 8 9
| | | * | | | | | | | | | | | |</pre></div><p class="para">If there is no preceding text, or only trailing text is specified, a comma
                    must immediately precede the text assertion:</p><div class="informalexample"><pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[,y])</pre></div><p class="para">There is no restriction on the amount of the preceding and following text that
                    can be included in the match. Text is taken from the document ignoring element
                    boundaries and whitespace is always collapsed (i.e., a non-empty sequence of
                    contiguous whitespace characters is always replaced with a single space
                    character).</p><p class="para">A Reading System may determine that the location referenced by the CFI is not
                    the original intended location (due to non-matching text), and may use the
                    preceding/trailing text to compute the set of steps that reach the desired
                    destination in the content (see <a class="xref" href="#sec-target-correction" title="3.5 Intended Target Location Correction">Intended Target Location Correction</a>). The
                    cost of this added robustness is that comparison (and sorting) of CFI strings
                    may only be performed after logically stripping all bracketed substrings (see
                        <a class="xref" href="#sec-sorting" title="3.2 Sorting Rules">Sorting Rules</a>).</p></div><div class="section" title="3.1.9 Side Bias ([ + ;s=)" id="sec-path-side-bias"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-side-bias">›</a> </span>3.1.9 Side Bias (<code class="literal">[</code> + <code class="literal">;s=</code>)</h4><p class="para">In some situations, it is important to preserve which side of a location a
                    reference points to. For example, when resolving a location in a dynamically
                    paginated environment, it would make a difference if a location is attached to
                    the content before or after it (e.g., to determine whether to display the verso
                    or recto side at a page break).</p><p class="para">The <code class="literal">s</code> parameter is used to preserve this sided-ness aspect
                    of a location. It can take two values: <code class="literal">b</code> means that the
                    location belongs with the content <span class="emphasis"><em>before</em></span> it and
                        <code class="literal">a</code> with the content <span class="emphasis"><em>after</em></span>. This
                    parameter must always be used inside square brackets at the end of the CFI, even
                    if the ID <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> or text location assertion is empty.</p><p class="para">The location just after <code class="literal">yyy</code> in the 
                    <a class="link" href="#sec-path-examples" title="3.1.10 Examples">sample content below</a> can be expressed as 
                    belonging with the content before it as follows:</p><div class="informalexample"><pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[;s=b])</pre></div><p class="para">Equally, it can be expressed including a text location assertion as:</p><div class="informalexample"><pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[yyy;s=b])</pre></div><p class="para">The location at the start of <code class="code">em</code> element can be attached to the
                    content preceding the <code class="code">em</code> element as follows:</p><div class="informalexample"><pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2[;s=b])</pre></div><p class="para">If the side bias in the preceding example was set to <code class="literal">a</code>
                    rather than <code class="literal">b</code>, the location would be attached to the child
                    content of the <code class="code">em</code> element, not the content following the
                        <code class="code">em</code> element.</p><p class="para">Since side bias is expressed as a parameter, it does not participate in
                    CFI comparison (see <a class="xref" href="#sec-sorting" title="3.2 Sorting Rules">Sorting Rules</a>).</p><p class="para">Side is not defined for locations with spatial terminus.</p><div class="note" title="note"><h3 class="title">note</h3><p class="para">Side bias is only meaningful when some type of break falls at the location 
                        (e.g., a page break or line break).</p></div></div><div class="section" title="3.1.10 Examples" id="sec-path-examples"><h4 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-path-examples">›</a> </span>3.1.10 Examples</h4><p class="informative"> This section is informative</p><p class="para">Given the following Package Document:</p><div class="informalexample"><pre class="synopsis">&lt;?xml version="1.0"?&gt;

&lt;package version="2.0" 
         unique-identifier="bookid" 
         xmlns="http://www.idpf.org/2007/opf"
         xmlns:dc="http://purl.org/dc/elements/1.1/" 
         xmlns:opf="http://www.idpf.org/2007/opf"&gt;
    
    &lt;metadata&gt;
        &lt;dc:title&gt;...&lt;/dc:title&gt;
        &lt;dc:identifier id="bookid"&gt;...&lt;/dc:identifier&gt;
        &lt;dc:creator&gt;...&lt;/dc:creator&gt;
        &lt;dc:language&gt;en&lt;/dc:language&gt;
    &lt;/metadata&gt;
    
    &lt;manifest&gt;
        &lt;item id="toc"
              properties="nav"
              href="toc.xhtml" 
              media-type="application/xhtml+xml"/&gt;
        &lt;item id="titlepage" 
              href="titlepage.xhtml" 
              media-type="application/xhtml+xml"/&gt;
        &lt;item id="chapter01" 
              href="chapter01.xhtml" 
              media-type="application/xhtml+xml"/&gt;
        &lt;item id="chapter02" 
              href="chapter02.xhtml" 
              media-type="application/xhtml+xml"/&gt;
        &lt;item id="chapter03" 
              href="chapter03.xhtml" 
              media-type="application/xhtml+xml"/&gt;
        &lt;item id="chapter04" 
              href="chapter04.xhtml" 
              media-type="application/xhtml+xml"/&gt;
    &lt;/manifest&gt;
    
    &lt;spine&gt;
        &lt;itemref id="titleref"  idref="titlepage"/&gt;
        &lt;itemref id="chap01ref" idref="chapter01"/&gt;
        &lt;itemref id="chap02ref" idref="chapter02"/&gt;
        &lt;itemref id="chap03ref" idref="chapter03"/&gt;
        &lt;itemref id="chap04ref" idref="chapter04"/&gt;
    &lt;/spine&gt;
    
&lt;/package&gt;
</pre></div><p class="para">and the XHTML Content Document <code class="filename">chapter01.xhtml</code>:</p><div class="informalexample"><pre class="synopsis">&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
    &lt;head&gt;
        &lt;title&gt;...&lt;/title&gt;
    &lt;/head&gt;
    
    &lt;body id="body01"&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p id="para05"&gt;xxx&lt;em&gt;yyy&lt;/em&gt;0123456789&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;img id="svgimg" src="foo.svg" alt="..."/&gt;
        &lt;p&gt;...&lt;/p&gt;
        &lt;p&gt;...&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre></div><p class="para">Then the EPUB CFI:</p><div class="informalexample"><pre class="synopsis">#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/3:10)</pre></div><p class="para">refers to the position right after the digit <code class="literal">9</code> in the paragraph with
                    the ID <code class="literal">para05</code>. When producing CFIs for text
                    locations, unless the text is defined by an <code class="code">img</code> element's
                        <code class="code">alt</code> tag, one should always start with the text node or text
                    node collection (even if empty) that corresponds to the location and then trace
                    the ancestor and reference chain to the Package Document root.</p><p class="para">The following examples show how EPUB CFIs can be constructed to reference
                    additional content locations.</p><div class="informalexample"><p class="para">Reference to the <code class="code">img</code> element.</p><pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/16[svgimg])</pre></div><div class="informalexample"><p class="para">Reference to the location just before <code class="literal">xxx</code>.</p><pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/1:0)</pre></div><div class="informalexample"><p class="para">Reference to the location just before <code class="literal">yyy</code>.</p><pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:0)</pre></div><div class="informalexample"><p class="para">Reference to the location just after <code class="literal">yyy</code>.</p><pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3)</pre></div></div></div><div class="section" title="3.2 Sorting Rules" id="sec-sorting"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-sorting">›</a> </span>3.2 Sorting Rules</h3><p class="para">In order to sort or compute relative locations of multiple EPUB CFIs referencing
                the same <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a>, the following rules must be applied:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="para">the "IRI un-escaped" core path is used;</p></li><li class="listitem"><p class="para">all bracketed annotations are removed or ignored entirely;</p></li><li class="listitem"><p class="para">steps that come earlier in the sequence are more important;</p></li><li class="listitem"><p class="para">XML child nodes, character offsets and temporal positions are sorted in
                        natural order;</p></li><li class="listitem"><p class="para">the <code class="literal">y</code> position is more important than
                            <code class="literal">x</code>;</p></li><li class="listitem"><p class="para">omitted spatial position precedes all other spatial positions;</p></li><li class="listitem"><p class="para">omitted temporal position precedes all other temporal positions;</p></li><li class="listitem"><p class="para">temporal position is more important than spatial;</p></li><li class="listitem"><p class="para">different step types come in the following order from least important to
                        most important: character offset (<code class="literal">:</code>), child
                            (<code class="literal">/</code>), temporal-spatial (<code class="literal">~</code> or
                            <code class="literal">@</code>), reference/indirect (<code class="literal">!</code>).</p></li></ol></div></div><div class="section" title="3.3 Intra-Publication CFIs" id="sec-intra-cfis"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-intra-cfis">›</a> </span>3.3 Intra-Publication CFIs</h3><p class="para">An EPUB CFI can be used to reference content inside the <a class="glossterm" href="#gloss-container" title="EPUB Container (or Container)">EPUB Container</a>. This kind of referencing can be achieved by
                specifying a reference to the <a class="glossterm" href="#gloss-package-document" title="Package Document">Package Document</a>
                followed by a CFI, which must be resolved starting from the root
                <code class="code">package</code> element.</p><p class="para">For example, using the Package Document in the <a class="link" href="#sec-path-examples" title="3.1.10 Examples">previous 
                example</a>, a reference to the last location in <code class="filename">chapter02.xhtml</code> 
                might be written as follows:</p><div class="informalexample"><pre class="synopsis">&lt;a href="pub.opf#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[;s=b])"&gt;location&lt;/a&gt;</pre></div></div><div class="section" title="3.4 Simple Ranges" id="sec-ranges"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-ranges">›</a> </span>3.4 Simple Ranges</h3><p class="para">EPUB CFIs allow the expression of simple ranges extending from a start location to
                an end location. A range must be expressed as a triple of
                    <span class="emphasis"><em>parent</em></span> path (<code class="literal">P</code>),
                    <span class="emphasis"><em>start</em></span> subpath (<code class="literal">S</code>) and
                    <span class="emphasis"><em>end</em></span> subpath (<code class="literal">E</code>), or of the form:</p><div class="informalexample"><pre class="synopsis">#epubcfi(P,S,E)</pre></div><p class="para">The parent path must end at a step that is common for resolving both the path of the 
                start and end locations of the range, and each start and end subpath must resolve to
                a location in non-decreasing order in the document.</p><p class="para">To determine the start and end locations of the range, the start and end subpaths
                must be concatenated to the parent path to create the start location path 
                (<code class="literal">PS</code>) and end location path (<code class="literal">PE</code>).</p><p class="para">Using the <a class="link" href="#sec-path-examples" title="3.1.10 Examples">sample documents above</a>, the 
                following range would represents the text from the second
                    <code class="literal">y</code> in <code class="literal">yyy</code> up to (and including) digit
                    <code class="literal">3</code>:</p><div class="informalexample"><pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05],/2/1:1,/3:4)</pre></div><p class="para">Ranges must be compared according to their <code class="literal">PS</code>, then 
                <code class="literal">PE</code>, components.</p><p class="para">It is not valid to use a path to an element as a shorthand for the range
                from the beginning to the end of the element. Single path notation always denotes a
                location point, and range is represented by the notation described above. There is no
                special step to produce a reference to the end of an element, as that would make
                sorting impossible without consulting the content of the document.</p><p class="para">If range is used where single location is expected by the context, the start
                location must be used.</p><p class="para">Side-bias parameters must not be used for ranges; the start of a range is
                implicitly attached to the content after the start location and the end is implicitly
                attached to the content before the end location.</p></div><div class="section" title="3.5 Intended Target Location Correction" id="sec-target-correction"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-target-correction">›</a> </span>3.5 Intended Target Location Correction</h3><p class="para">As an <a class="glossterm" href="#gloss-epub-publication" title="EPUB Publication (or Publication)">EPUB Publication</a> may be updated, corrected or 
                otherwise altered over time, it is 
                useful to be able to derive an EPUB CFI for the modified document from one that 
                targeted a previous version. This specification provides two mechanisms to detect and 
                adapt to content changes that impact CFIs: IDs <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> and 
                <a class="link" href="#sec-path-text-location" title="3.1.8 Text Location Assertion ([)">text location assertions</a>.</p><p class="para">When a <a class="glossterm" href="#gloss-epub-reading-system" title="EPUB Reading System (or Reading System)">EPUB Reading System</a> is processing a CFI, it should check the 
                correctness of any
                encountered assertions. For example, given the path <code class="literal">/6/4[chap01ref]!...</code>,
                the Reading System should verify that the element has the ID matching <code class="literal">chap01ref</code>
                when processing element <code class="literal">4</code> (for this example, an <code class="code">itemref</code> in the
                <code class="code">spine</code>). If not, the Reading System should locate the ID <code class="literal">chap01ref</code> 
                within the document and correct the CFI (e.g., if a new <code class="code">itemref</code> was inserted before the
                    <code class="literal">chap01ref</code> <code class="code">itemref</code>, the desired element number would now 
                be <code class="literal">6</code> and the corrected CFI would be <code class="literal">/6/6[chap01ref]!...</code>). 
                Likewise, text location assertions should be used to check referenced target locations, and used 
                to derive a corrected CFI that targets the desired text location.</p><p class="para">If one of the assertions fails during processing, and a corrected CFI can not be
                derived (the ID is not found in the document, or text matches could not be found), the
                CFI must be considered an invalid reference. In cases where a Reading System cannot
                check for correctness (e.g. document-resident XML IDs are not available at CFI
                processing time), a Reading System must ignore the CFI assertions.</p><p class="para">This notion of correcting CFIs can lead to circumstances where two different
                CFIs point to the same location (i.e. the "stale" CFI, pre-correction, and the
                corrected CFI). The corrected CFI should be used where possible. A Reading System
                and any surrounding content management system should attempt to replace stale CFIs
                with their corrected versions where possible.</p><div class="note" title="note"><h3 class="title">note</h3><p class="para">This specification encourages the development of custom functions to assist with
                    CFI correction where the intrinsic functionality is insufficient. Refer to 
                    <a class="xref" href="#sec-extensions" title="4 Extending EPUB CFIs"><em>Extending EPUB CFIs</em></a> for more information on how to develop such functionality.</p></div></div></div><div class="chapter" title="4 Extending EPUB CFIs" id="sec-extensions"><h2 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#sec-extensions">›</a> </span>4 Extending EPUB CFIs</h2><p class="para">The provision for extensions (CSV parameter lists, prefixed by a parameter name, 
            and separated by semicolons) allow <a class="glossterm" href="#gloss-epub-reading-system" title="EPUB Reading System (or Reading System)">EPUB Reading System</a>s to 
            apply new or experimental heuristics 
            to assist, for example, in migrating EPUB CFI fragments to updated documents.</p><p class="para">It is recommended that any vendor-specific parameter names start with
            <code class="literal">vnd.</code> followed by the vendor name.</p><p class="para">Implementations must ignore all parameters that they do not understand or 
            cannot parse.</p></div><div class="bibliography" title="References" id="references"><div class="titlepage"><div><div><h2 class="title"><span class="link-marker"><a class="hidden-reveal" title="Link here" href="#references">›</a> </span>References</h2></div></div></div><div class="bibliodiv" title="Normative References"><h3 class="title">Normative References</h3><div class="biblioentry" title="EPUB Content Documents 3.0" id="refContentDocs3"><p>[<abbr class="abbrev">ContentDocs30</abbr>] <span class="title"><em><a class="link" href="epub30-contentdocs.html">EPUB Content Documents
                3.0</a></em>. </span></p></div><div class="biblioentry" title="EPUB Canonical Fragment Identifier (epubcfi) Specification" id="refEPUBCFI"><p>[<abbr class="abbrev">EPUBCFI</abbr>] <span class="title"><em><a class="link" href="http://www.idpf.org/epub/linking/cfi/epub-cfi.html">EPUB Canonical 
                Fragment Identifier (epubcfi) Specification</a></em>. </span></p></div><div class="biblioentry" title="HTML5: A vocabulary and associated APIs for HTML and XHTML" id="refHTML5"><p>[<abbr class="abbrev">HTML5</abbr>] <span class="title"><em><a class="link" href="http://www.w3.org/TR/html5/">HTML5: A vocabulary and associated
                    APIs for HTML and XHTML</a></em>. </span></p></div><div class="biblioentry" title="EPUB Media Overlays 3.0" id="refOverlays3"><p>[<abbr class="abbrev">MediaOverlays30</abbr>] <span class="title"><em><a class="link" href="epub30-mediaoverlays.html">EPUB Media Overlays
                3.0</a></em>. </span></p></div><div class="biblioentry" title="Open Container Format 3.0" id="refOCF30"><p>[<abbr class="abbrev">OCF3</abbr>] <span class="title"><em><a class="link" href="epub30-ocf.html">Open Container Format 3.0</a></em>. </span></p></div><div class="biblioentry" title="EPUB Publications 3.0" id="refPublications3"><p>[<abbr class="abbrev">Publications30</abbr>] <span class="title"><em><a class="link" href="epub30-publications.html">EPUB Publications 3.0</a></em>. </span></p></div><div class="biblioentry" title="Key words for use in RFCs to Indicate Requirement Levels (RFC 2119)" id="refRFC2119"><p>[<abbr class="abbrev">RFC2119</abbr>] <span class="title"><em>
                <a class="link" href="http://www.ietf.org/rfc/rfc2119.txt">Key words for use in RFCs to
                    Indicate Requirement Levels</a> (RFC 2119) </em>. </span><span class="date">March 1997. </span></p></div><div class="biblioentry" title="Internationalized Resource Identifiers (IRIs) (RFC 3987)" id="refRFC3987"><p>[<abbr class="abbrev">RFC3987</abbr>] <span class="title"><em>
                <a class="link" href="http://www.ietf.org/rfc/rfc3987.txt">Internationalized Resource
                    Identifiers (IRIs)</a> (RFC 3987) </em>. </span><span class="author">M Duerst, et al. </span><span class="date">January 2005. </span></p></div><div class="biblioentry" title="Scalable Vector Graphics (SVG) 1.1 (Second Edition)" id="refSVG"><p>[<abbr class="abbrev">SVG</abbr>] <span class="title"><em>
                <a class="link" href="http://www.w3.org/TR/SVG11/">Scalable Vector Graphics (SVG) 1.1
                    (Second Edition)</a>
            </em>. </span><span class="author">Erik Dahlström, et al. </span><span class="date">22 June 2010. </span></p></div><div class="biblioentry" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)" id="refXML"><p>[<abbr class="abbrev">XML</abbr>] <span class="title"><em>
                <a class="link" href="http://www.w3.org/TR/2008/REC-xml-20081126/">Extensible Markup
                    Language (XML) 1.0 (Fifth Edition)</a>
            </em>. </span><span class="author">T. Bray, et al. </span><span class="date">26 November 2008. </span></p></div></div><div class="bibliodiv" title="Informative References"><h3 class="title">Informative References</h3><div class="biblioentry" title="XPointer Shorthand Notation" id="refXPTRSH"><p>[<abbr class="abbrev">XPTRSH</abbr>] <span class="title"><em><a class="link" href="http://www.w3.org/TR/xptr-framework/#shorthand">XPointer
                    Shorthand Notation</a></em>. </span></p></div></div></div></div></body></html>